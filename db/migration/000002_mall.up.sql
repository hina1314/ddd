CREATE TABLE product (
                         id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                         name TEXT NOT NULL,
                         description TEXT,
                         price NUMERIC(10, 2) NOT NULL,
                         images TEXT,
                         created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
                         updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
                         deleted_at TIMESTAMPTZ
);
COMMENT ON TABLE product IS '商品';

CREATE TABLE product_sku (
                         id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                         product_id INTEGER NOT NULL,
                         name TEXT NOT NULL,
                         specs JSONB,   -- {"color": "black", "size": "M"}
                         price NUMERIC(10, 2) NOT NULL,
                         images TEXT,
                         created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
                         updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
                         deleted_at TIMESTAMPTZ
);
COMMENT ON TABLE product_sku IS '商品SKU';

CREATE TABLE product_sku_stock (
                           sku_id INTEGER PRIMARY KEY,
                           stock INTEGER NOT NULL CHECK (stock >= 0)
);

CREATE INDEX "idx_product_sku_id" ON "public"."product_sku_stock" ("sku_id");
COMMENT ON TABLE product_sku_stock IS '库存';



CREATE TABLE "order" (
                         id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                         order_no VARCHAR(30) NOT NULL,
                         user_id INTEGER NOT NULL,
                         status smallint NOT NULL DEFAULT 0,
                         total_amount NUMERIC(10, 2) NOT NULL,
                         paid_at TIMESTAMPTZ,
                         expire_at TIMESTAMPTZ,
                         created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE UNIQUE INDEX "idx_order_order_no" ON "public"."order" ("order_no");
CREATE INDEX "idx_order_user_id" ON "public"."order" ("user_id");
COMMENT ON TABLE "order" IS '订单';


CREATE TABLE order_item (
                            id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                            order_id INTEGER NOT NULL,
                            product_id INTEGER NOT NULL,
                            quantity INTEGER NOT NULL CHECK (quantity > 0),
                            unit_price NUMERIC(10, 2) NOT NULL
);

CREATE INDEX "idx_order_items_order_id" ON "public"."order_item" ("order_id");
CREATE INDEX "idx_order_items_product_id" ON "public"."order_item" ("product_id");
COMMENT ON TABLE order_item IS '订单项目';


CREATE TABLE cart (
                            id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                            user_id BIGINT NOT NULL,
                            sku_id BIGINT NOT NULL,
                            quantity INTEGER NOT NULL CHECK (quantity > 0),
                            price NUMERIC(10, 2) NOT NULL,
                            created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
                            updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE INDEX "idx_cart_user_id" ON "public"."cart" ("user_id");
CREATE INDEX "idx_cart_sku_id" ON "public"."cart" ("sku_id");
CREATE UNIQUE INDEX uniq_user_sku ON cart (user_id, sku_id);
COMMENT ON TABLE "cart" IS '购物车';